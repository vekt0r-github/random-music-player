<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>audio test</title>
    <meta name="description" content="can i play audio">
    <meta name="author" content="vluo">
    <link rel="stylesheet" href="index.css">
  </head>
  <body>
    <h1>random music player</h1>
    <div>
      <button type="button" id="start">start</button>
      <button type="button" id="refresh">refresh</button>
      <button type="button" id="test">mobile testing button</button>
    </div>
    <div>
      <button type="button" id="prev">&lt;</button>
      <button type="button" id="next">&gt;</button>
    </div>
    <div>
      <label for="noRepeatNum">no repeat: </label><input type="text" id="noRepeatNum"><br>
      <label for="rowsBefore">rows before: </label><input type="text" id="rowsBefore"><br>
      <label for="rowsAfter">rows after: </label><input type="text" id="rowsAfter">
    </div>
    <div>
      <audio id="player" controls>
        <source src="" type="audio/mp3">
        text if audio doesn't work
      </audio>
    </div>
    <div id="playlist"></div>
    <script>
      alert("hello user at the beginning");

      // utils.js
      const random = (min, max) => Math.floor(Math.random() * (max - min)) + min;
      const randomChoice = (x) => x[random(0, x.length)];

      // player.js
      class Player {
        /**
         * Turns audioElement into an audio player which plays
         * random songs from pool
         * @param {HTML element} audioElement 
         * @param {list} pool-- each song is {path, displayName, id}
         * @param {int} bufferSize 
         */
        constructor(audioElement, pool) {
          this.audioElement = audioElement;
          this.pool = pool;
          this.poolSize = pool.length;
          // default values
          this._bufferSize = 0;
          this._autoplay = false; 
          this._volume = 1.0; 
          this._noRepeatNum = 0;
        }

        #bufferOne() {
          console.assert(this._noRepeatNum < this.poolSize);
          const newIndex = randomChoice([...this.availableIndices]);
          if (this._noRepeatNum > 0) {
            const addBackIndex = this.playlist.length - this._noRepeatNum;
            if (addBackIndex >= 0) {
              const oldIndex = this.playlist[addBackIndex].id;
              this.availableIndices.add(oldIndex);
            }
            this.availableIndices.delete(newIndex);
          }
          this.playlist.push(this.pool[newIndex]);
          // console.log(this);
        }

        /**
         * generates future songs, up to buffer specified by this.bufferSize
         */
        buffer() {
          while (this.playlist.length - this.currSong - 1 < this.bufferSize) {
            this.#bufferOne();
          }
        }

        /**
         * regenerates everything after currSong if user doesn't like it
         */
        rebuffer() {
          this.playlist = this.playlist.slice(0, this.currSong + 1);
          this.buffer();
        }

        playPrev(num = 1) {
          this.currSong = Math.max(0, this.currSong - num);
          this.playCurr();
        }

        playCurr() {
          const song = this.playlist[this.currSong];
          this.audioElement.src = song.path;
          this.audioElement.play();
        }

        playNext(num = 1) {
          this.currSong += num;
          this.buffer();
          this.playCurr();
        }

        get bufferSize() { return this._bufferSize; }

        set bufferSize(value) {
          this._bufferSize = value;
          this.buffer();
        }

        get autoplay() { return this._autoplay; }

        set autoplay(value) {
          this._autoplay = value;
          const operation = (value ? 'add' : 'remove') + 'EventListener';
          this.audioElement[operation]("ended", () => this.playNext.bind(this)());
        }

        get volume() { return this._volume; }

        set volume(value) {
          this._volume = value;
          this.audioElement.volume = value;
        }

        get noRepeatNum() { return this._noRepeatNum; }

        set noRepeatNum(value) {
          this._noRepeatNum = value;
          this.rebuffer(); // i guess
        }

        reset() {
          this.playlist = [];
          this.currSong = 0;
          this.availableIndices = new Set(this.pool.keys());
          this.buffer();
        }
      };

      // playerDisplay.js
      class PlayerDisplay extends Player {
        constructor(audioElement, displayElement, pool) {
          super(audioElement, pool);
          this.displayElement = displayElement;
          // default values
          this._rowsBefore = 0; // number of entries to display before current song
          this._rowsAfter = 0;
        }

        buffer() {
          super.buffer();
          this.refreshPlaylist();
        }

        playCurr() {
          super.playCurr();
          this.refreshPlaylist();
        }
        
        /**
         * creates an HTML table showing recent/coming up songs
         */
        refreshPlaylist() {
          var table = document.createElement('table');
          table.classList.add("playlist");
          const fromSong = this.currSong - this._rowsBefore;
          const toSong = this.currSong + this._rowsAfter;
          for (var i = fromSong; i <= toSong; i++) {
            var row = document.createElement('tr');
            var cell = document.createElement('td');
            var title = '';
            if (i >= 0 && i < this.playlist.length) {
              title = this.playlist[i].displayName;
              const diff = i - this.currSong;
              if (diff === 0) {
                row.classList.add("selected");
              } else if (diff < 0) {
                // console.log(i + ' is less than ' + this.currSong);
                cell.onclick = () => this.playPrev.bind(this)(-diff);
              } else {
                // console.log(i + ' is more than ' + this.currSong);
                cell.onclick = () => this.playNext.bind(this)(diff);
              }
            }
            cell.innerHTML = title;
            row.appendChild(cell);
            table.appendChild(row);
          }
          const oldChild = this.displayElement.firstChild;
          if (oldChild === null) {
            this.displayElement.appendChild(table);
          } else {
            this.displayElement.replaceChild(table, oldChild);
          }
        }

        get rowsBefore() { return this._rowsBefore; }

        set rowsBefore(value) {
          this._rowsBefore = value;
          this.refreshPlaylist();
        }

        get rowsAfter() { return this._rowsAfter; }

        set rowsAfter(value) {
          this._rowsAfter = value;
          this.bufferSize = value;
          this.refreshPlaylist();
        }

        reset() {
          super.reset();
          this.refreshPlaylist();
        }
      }

      // testAudio.js
      const audioPath = 'test/';

      function loadData(fn, callback) {
        var oReq = new XMLHttpRequest(); // New request object
        oReq.onload = function() {
          // This is where you handle what to do with the response.
          // The actual data is found on this.responseText
          callback(this.responseText); 
        };
        oReq.open("get", fn, true);
        //                   ^ Don't block the rest of the execution.
        //                     Don't wait until the request finishes to
        //                     continue.
        oReq.send();
      }

      function executeIfInt(value, callback) {
        if (Number.isInteger(+value)) {
          callback(+value);
        }
      }

      function initPlayer(pool) {
        // console.log(pool_json);
        const box = document.getElementById("hellosu");
        const audio = document.getElementById("player");
        const table = document.getElementById("playlist");

        const player = new PlayerDisplay(audio, table, pool);
        player.reset();
        player.volume = 0.25;
        player.autoplay = true;
        player.playCurr();
        document.getElementById("refresh").onclick = () => player.refreshPlaylist.bind(player)();
        document.getElementById("prev").onclick = () => player.playPrev.bind(player)();
        document.getElementById("next").onclick = () => player.playNext.bind(player)();
        const setupInput = (elementId, defaultValue, callback) => {
          const element = document.getElementById(elementId);
          element.value = defaultValue;
          callback(defaultValue);
          element.onchange = () => executeIfInt(element.value, callback);
        }
        setupInput("noRepeatNum", 10, (x) => player.noRepeatNum = x);
        setupInput("rowsBefore", 10, (x) => player.rowsBefore = x);
        setupInput("rowsAfter", 10, (x) => player.rowsAfter = x);
      }

      const startButton = document.getElementById("start")

      const start = () => {
        loadData('songs.json', (pool_json) => initPlayer(JSON.parse(pool_json)));
        startButton.removeEventListener('click', start);
      };
      startButton.addEventListener('click', start);

      document.getElementById("test").addEventListener('click', () => alert("the test button was clicked"));
      alert("hello user");

    </script>
    <noscript>Sorry, your browser does not support JavaScript!</noscript>
  </body>
</html>