<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>audio test</title>
    <meta name="description" content="can i play audio">
    <meta name="author" content="vluo">
    <link rel="stylesheet" href="index.css">
  </head>
  <body>
    <h1>random music player</h1>
    <div>
      <button type="button" id="start">start</button>
      <button type="button" id="refresh">refresh</button>
      <button type="button" id="test">mobile testing button</button>
    </div>
    <div>
      <button type="button" id="prev">&lt;</button>
      <button type="button" id="next">&gt;</button>
    </div>
    <div>
      <label for="noRepeatNum">no repeat: </label><input type="text" id="noRepeatNum"><br>
      <label for="rowsBefore">rows before: </label><input type="text" id="rowsBefore"><br>
      <label for="rowsAfter">rows after: </label><input type="text" id="rowsAfter">
    </div>
    <div>
      <audio id="player" controls>
        <source src="" type="audio/mp3">
        text if audio doesn't work
      </audio>
    </div>
    <div id="playlist"></div>
    <script>
      alert("hello user at the beginning");
      document.getElementById("noRepeatNum").value = 123;

      // utils.js
      const random = (min, max) => Math.floor(Math.random() * (max - min)) + min;
      const randomChoice = (x) => x[random(0, x.length)];

      // player.js
      class Player {
        /**
         * Turns audioElement into an audio player which plays
         * random songs from pool
         * @param {HTML element} audioElement 
         * @param {list} pool-- each song is {path, displayName, id}
         * @param {int} bufferSize 
         */
        constructor(audioElement, pool) {
          this.audioElement = audioElement;
          this.pool = pool;
          this.poolSize = pool.length;
          // default values
          this._bufferSize = 0;
          this._autoplay = false; 
          this._volume = 1.0; 
          this._noRepeatNum = 0;
        }

        bufferOne() {
          console.assert(this._noRepeatNum < this.poolSize);
          const newIndex = randomChoice([...this.availableIndices]);
          if (this._noRepeatNum > 0) {
            const addBackIndex = this.playlist.length - this._noRepeatNum;
            if (addBackIndex >= 0) {
              const oldIndex = this.playlist[addBackIndex].id;
              this.availableIndices.add(oldIndex);
            }
            this.availableIndices.delete(newIndex);
          }
          this.playlist.push(this.pool[newIndex]);
          // console.log(this);
        }

        /**
         * generates future songs, up to buffer specified by this.bufferSize
         */
        buffer() {
          while (this.playlist.length - this.currSong - 1 < this.bufferSize) {
            this.bufferOne();
          }
        }

        /**
         * regenerates everything after currSong if user doesn't like it
         */
        rebuffer() {
          this.playlist = this.playlist.slice(0, this.currSong + 1);
          this.buffer();
        }

        playPrev(num = 1) {
          this.currSong = Math.max(0, this.currSong - num);
          this.playCurr();
        }

        playCurr() {
          const song = this.playlist[this.currSong];
          this.audioElement.src = song.path;
          this.audioElement.play();
        }

        playNext(num = 1) {
          this.currSong += num;
          this.buffer();
          this.playCurr();
        }

        get bufferSize() { return this._bufferSize; }

        set bufferSize(value) {
          this._bufferSize = value;
          this.buffer();
        }

        get autoplay() { return this._autoplay; }

        set autoplay(value) {
          this._autoplay = value;
          const operation = (value ? 'add' : 'remove') + 'EventListener';
          this.audioElement[operation]("ended", () => this.playNext.bind(this)());
        }

        get volume() { return this._volume; }

        set volume(value) {
          this._volume = value;
          this.audioElement.volume = value;
        }

        get noRepeatNum() { return this._noRepeatNum; }

        set noRepeatNum(value) {
          this._noRepeatNum = value;
          this.rebuffer(); // i guess
        }

        reset() {
          this.playlist = [];
          this.currSong = 0;
          this.availableIndices = new Set(this.pool.keys());
          this.buffer();
        }
      };

      
      alert("i wonder if i can do player");
      document.getElementById("noRepeatNum").value = 333;

    </script>
    <noscript>Sorry, your browser does not support JavaScript!</noscript>
  </body>
</html>